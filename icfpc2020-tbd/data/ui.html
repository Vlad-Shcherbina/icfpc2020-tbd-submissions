<!doctype html>
<html>
<head>
	<meta charset='utf-8'>
	<title>ðŸ‘½ hi</title>
	<style>
canvas {
	image-rendering: optimizeSpeed;;
}
canvas.busy {
	pointer-events: none;
	mask-image: linear-gradient(rgba(0, 0, 0, 1.0), transparent);;
}
	</style>
	<script type="text/javascript">
var State = "(2, ((1, (-1, nil)), (0, (nil, nil))))"

var OffsetX = -200
var OffsetY = -200
var Colors = [
	'rgb(255, 0, 0)', 'rgb(0, 255, 0)', 'rgb(0, 0, 255)',
	'rgb(255, 255, 255)',
	'rgb(255, 255, 0)', 'rgb(255, 0, 255)', 'rgb(0, 255, 255)'
]

function set_state(state) {
	State = state
	document.getElementById('state').innerText = State
}

function send_click(x, y) {
	document.getElementById('canvas').classList.add('busy')
	fetch('/click', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({x, y, state: State}),
	})
		.then(response => response.json())
		.then(({pixels, state, pretty_state}) => {
			set_state(state)
			document.getElementById('pretty_state').innerText = pretty_state

			draw_pixels(pixels)
			document.getElementById('canvas').classList.remove('busy')
		})
}

function draw_pixels(pixels) {
	const canvas = document.getElementById('canvas')
	const ctx = canvas.getContext('2d')

	// OffsetX = Math.min(...pixels.map(l => Math.min(...l.map(p => p[0]))))
	// OffsetY = Math.min(...pixels.map(l => Math.min(...l.map(p => p[1]))))

	ctx.fillStyle = 'rgb(0, 0, 0)'
	ctx.fillRect(0, 0, canvas.width, canvas.height)

	for (let i = 0; i < pixels.length; i++) {
		const ii = pixels.length - 1 - i
		ctx.fillStyle = Colors[i]
		for (let [x, y] of pixels[ii]) {
			ctx.fillRect(x - OffsetX, y - OffsetY, 1, 1)
		}
	}
}

function load() {
	send_click(-2, 4)

	const canvas = document.getElementById('canvas')
	canvas.addEventListener('click', e => {
		const rect = canvas.getBoundingClientRect()
	    const x = e.clientX - rect.left + OffsetX
	    const y = e.clientY - rect.top + OffsetY
	    send_click(Math.round(x), Math.round(y))
	})

	document.getElementById('new_state_go').addEventListener('click', e => {
		let new_state = document.getElementById('new_state').value
		set_state(new_state)
	})

	document.getElementById('click_go').addEventListener('click', e => {
		let x = parseInt(document.getElementById('click_x').value)
		let y = parseInt(document.getElementById('click_y').value)
		send_click(x, y)
	})

	document.getElementById('jump_battle_select').addEventListener('click', e => {
		let new_state = '(5, ((2, (0, (nil, (nil, (nil, (nil, (nil, (54179, nil)))))))), (8, (nil, nil))))'
		let x = 0
		let y = 0
		set_state(new_state)
		send_click(x, y)
	})
}
	</script>
</head>
<body onload="load()">
	<canvas id='canvas' width=400 height=400></canvas>
	<p>shortcuts: <button id='jump_battle_select'>battle selection screen</button></p>
	<p>change state: <textarea id='new_state'></textarea><button id='new_state_go'>go</button></p>
	<p>simulate click: <input type='number' id='click_x' value=0> <input type='number' id='click_y' value=0> <button id='click_go'>go</button></p>
	<p>prettified state is <span id='pretty_state'></span></p>
	<p>state is <span id='state'></span></p>
</body>
</html>
